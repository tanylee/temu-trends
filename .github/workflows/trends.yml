name: trends
on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # каждые 6 часов

jobs:
  trends:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          npm install
          npx playwright install --with-deps  # скачивает Chromium и нужные пакеты

      - name: Check Pinterest cookie
        run: |
          node -e '
          const cookies = JSON.parse(process.env.PINTEREST_COOKIE || "[]");
          const header = cookies.map(c => `${c.name}=${c.value}`).join("; ");
          fetch("https://www.pinterest.com/", { headers: { cookie: header }, redirect: "manual" })
            .then(r => {
              console.log("Pinterest status:", r.status, r.headers.get("location") || "");
              if (r.status !== 200) process.exit(2);
            })
            .catch(e => { console.error(e); process.exit(2); });
          '
        env:
          PINTEREST_COOKIE: ${{ secrets.PINTEREST_COOKIE }}

      - name: Collect 3-month trends
        run: node scripts/collect_trends.js
        env:
          OXYLABS_USER: ${{ secrets.OXYLABS_USER }}
          OXYLABS_PASS: ${{ secrets.OXYLABS_PASS }}
          OXY_ENDPOINT: ${{ secrets.OXY_ENDPOINT }}

      - name: Collect seasonal trends
        run: node scripts/collect_seasonal.js

      - name: Map trends to Temu
        run: node scripts/map_trends_to_temu.js

      - name: Validate Temu links & images
        run: node scripts/validate_temu_links.js

      - name: Score & merge
        run: node scripts/score_trends.js

      - name: Commit data
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"
          git add data/
          git commit -m "update data" || echo "no changes"
          git push

      - name: Notify success
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="✅ Temu Trends обновлен успешно!"

      - name: Notify failure
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="❌ Temu Trends упал. Проверь логи GitHub Actions."
