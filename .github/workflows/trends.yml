name: trends

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

permissions:
  contents: write

jobs:
  trends:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: |
          npm install --no-audit --no-fund

      - name: Check Pinterest cookie
        env:
          PINTEREST_COOKIE: ${{ secrets.PINTEREST_COOKIE }}
        run: |
          node -e '
          const cookies = JSON.parse(process.env.PINTEREST_COOKIE||"[]");
          const header = cookies.map(c=>`${c.name}=${c.value}`).join("; ");
          fetch("https://www.pinterest.com/", { headers: { cookie: header }, redirect:"manual"})
            .then(r => {
              console.log("Pinterest status:", r.status, r.headers.get("location")||"");
              if (r.status !== 200) process.exit(2);
            })
            .catch(e => { console.error(e); process.exit(2); });
          '

      - name: Collect 3-month trends
        env:
          OXYLABS_USER: ${{ secrets.OXYLABS_USER }}
          OXYLABS_PASS: ${{ secrets.OXYLABS_PASS }}
          OXY_ENDPOINT: ${{ secrets.OXY_ENDPOINT }}
        run: |
          npm run trends:collect

      - name: Collect seasonal trends
        run: |
          npm run trends:seasonal

      - name: Aggregate trends
        run: |
          npm run trends:aggregate

      - name: Build pages
        run: |
          npm run build:pages

      - name: Commit data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update products and trends data"
          file_pattern: |
            data/**
            public/**
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com

      - name: Trigger Netlify build
        if: success()
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
            "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID/builds" \
          | jq -r '.state // "queued"'

      # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∞–≤—Ç–æ–ø–æ—Å—Ç –≤ Pinterest ‚Äî –µ—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ —Ä–∞–±–æ—á–∏–π —Å–∫—Ä–∏–ø—Ç
      - name: Auto-post pins to Pinterest
        if: success()
        env:
          PINTEREST_COOKIE: ${{ secrets.PINTEREST_COOKIE }}
        run: |
          npm run post:pins

      - name: Notify success (Telegram)
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="$TG_CHAT" \
            --data-urlencode text="‚úÖ TEMU Trends: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ üöÄ"

      - name: Notify failure (Telegram)
        if: failure()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="$TG_CHAT" \
            --data-urlencode text="‚ùå –û—à–∏–±–∫–∞ –≤ TEMU Trends workflow. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Actions."
